<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>productDetail</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
            crossorigin="anonymous"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link th:href="@{/css/style.css}" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap"
          rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/pretendard.css">

    <script>
        $(document).ready(function () {
            $("#copyBtn").on("click", function () {
                // í˜„ì¬ í˜ì´ì§€ URL ê°€ì ¸ì˜¤ê¸°
                let currentUrl = window.location.href;

                // ì„ì‹œ input ìš”ì†Œ ìƒì„±í•´ì„œ URL ë„£ê³  ì„ íƒ
                const tempInput = $("<input>");
                $("body").append(tempInput);
                tempInput.val(currentUrl).select();

                // ë³µì‚¬ ì‹¤í–‰
                document.execCommand("copy");

                // ì„ì‹œ input ì‚­ì œ
                tempInput.remove();

                // ì•Œë¦¼ ë³´ì—¬ì£¼ê¸°
                $("#copyAlert").fadeIn().delay(1000).fadeOut();
            });
        });
    </script>

</head>

<body class="pretendard">

<div th:replace="layout/header :: header"></div>

<div class="d-flex flex-row justify-content-center mt-5">
    <div class="container-fluid overflow-y-scroll mt-4" style="max-height: 100vh;">
        <h2 class="text-center mb-5 montserrat montserrat_pro"
            style="font-size: 40px; filter: drop-shadow(0 0 1.5px #ffffff);">DETAIL</h2>
        <div th:each="img : ${imageList}" class="text-center">
            <img th:src="@{${img}}" alt="ìƒí’ˆì´ë¯¸ì§€" class="img-fluid mb-4" style="width: 300px;">
            <hr>
        </div>

        <p class="mt-4 mb-4 text-center">ì´ ìƒí’ˆì˜ ì—°ê´€ìƒí’ˆ</p>
        <div class="d-flex flex-row gap-3"
             style="overflow-x: auto; flex-wrap: nowrap; white-space: nowrap;">
            <a th:each="related : ${relatedList}"
               th:href="@{'/productDetail?id=' + ${related.productId}}"
               class="text-decoration-none"
               style="width: 100px; flex: 0 0 auto;">
                <img th:src="@{${related.productThumnail}}" alt="ì—°ê´€ ìƒí’ˆ"
                     style="width: 100px; height: 100px; object-fit: cover;" class="rounded shadow-sm mb-5">
            </a>
        </div>
        <hr>
    </div>
    <div class="container overflow-y-hidden" style="max-height: 100vh;">
        <div class="d-flex flex-column align-items-center gap-3">
            <p id="copyAlert" style="display:none; color:#ff8117;">URLì´ ë³µì‚¬ë˜ì—ˆì–´ìš”! ğŸ’™</p>
            <div class="d-flex flex-row align-items-center gap-3">
                <p th:text="${product.productName} + ' / ' + ${product.productPrice} + 'ì›'">ìƒí’ˆëª… / ê°€ê²©</p>
                <button type="submit" class="btn d-flex justify-content-center align-items-center"
                        style="height: 60px; width: 60px;" id="copyBtn"><img src="/img/svg/share.svg" alt="ê³µìœ "
                                                                             style="height: 45px; width: 45px;">
                </button>
            </div>

            <!-- ëŒ€í‘œ ì´ë¯¸ì§€ -->
            <img th:src="@{${product.productThumnail}}" alt="ìƒí’ˆ ì´ë¯¸ì§€"
                 style="width:300px; height:300px; object-fit:cover;" class="mb-5">

        </div>

        <!-- ì˜µì…˜ ì„ íƒ -->
        <div class="d-flex flex-column align-items-center gap-3">
            <select id="colorSelect" class="form-select" style="width: 200px;">
                <option selected disabled>ìƒ‰ìƒ ì„ íƒ</option>
                <option th:each="color : ${colorList}" th:value="${#strings.trim(color)}"
                        th:text="${#strings.trim(color)}"></option>
            </select>

            <select id="sizeSelect" class="form-select" style="width: 200px;">
                <option selected disabled>ì‚¬ì´ì¦ˆ ì„ íƒ</option>
                <option th:each="size : ${sizeList}" th:value="${#strings.trim(size)}"
                        th:text="${#strings.trim(size)}"></option>
            </select>
        </div>

        <!-- ì°œ, ì¥ë°”êµ¬ë‹ˆ, ë°”ë¡œêµ¬ë§¤ ê¸°ëŠ¥ -->
        <div class="d-flex justify-content-center" style="height: 100%;">
            <div id="product-detail" th:data-product-id="${product.productId}"
                 th:data-login-id="${loginId}" class="d-flex flex-column align-items-center">
                <div class="d-flex flex-row gap-4 mt-4">
                    <!-- ì°œ ë²„íŠ¼ -->
                    <button th:attr="data-product-id=${product.productId}"
                            type="button" id="btn-wish" class="btn d-flex justify-content-center align-items-center"
                            style="height: 50px; width: 50px;" data-wished="false">
                        <img id="wishIcon" src="/img/svg/wish-non.svg" alt="ì°œ" style="height: 50px; width: 50px;">
                    </button>

                    <!-- ì¥ë°”êµ¬ë‹ˆ -->
                    <button th:attr="data-product-id=${product.productId}"
                            type="button" id="btn-cart" class="btn d-flex justify-content-center align-items-center"
                            style="height: 50px; width: 50px;">
                        <img src="/img/svg/cart.svg" alt="ì¥ë°”êµ¬ë‹ˆ" style="height: 55px; width: 55px;">
                    </button>

                    <!-- ë°”ë¡œêµ¬ë§¤ -->
                    <button type="button" id="buyNowBtn" class="btn d-flex justify-content-center align-items-center"
                            style="height: 50px; width: 50px;"
                            th:attr="data-product-id=${product.productId}">
                        <img src="/img/svg/won.svg" alt="ë°”ë¡œêµ¬ë§¤" style="height: 35px; width: 35px;">
                    </button>
                </div>
            </div>
        </div>
        <script th:inline="javascript">
            $(document).ready(function () {
                const productId = $('#product-detail').data('productId');
                const userId = $('#product-detail').data('customerId');
                const isLoggedIn = $('#product-detail').data('login');

                // ì°œ ë²„íŠ¼
                let wishClicked = false;

                $('#btn-wish').off('click').on('click', function () {
                    if (wishClicked) return;
                    wishClicked = true;

                    const productId = $(this).data('product-id');
                    const cartColor = $('#colorSelect').val();
                    const cartSize = $('#sizeSelect').val();

                    if (!cartColor || !cartSize) {
                        alert("ì˜µì…˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                        wishClicked = false;
                        return;
                    }

                    $.ajax({
                        url: '/wish/add',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({productId: productId}),
                        success: function (res) {
                            alert(res); // ì°œ ì™„ë£Œ
                        },
                        error: function (xhr) {
                            if (xhr.status === 401) {
                                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                                window.location.href = '/login';
                            } else if (xhr.status === 409) {
                                alert('ì´ë¯¸ ì°œí•œ ìƒí’ˆì…ë‹ˆë‹¤.');
                            } else {
                                alert('ì°œ ì‹¤íŒ¨');
                            }
                        },
                        complete: function () {
                            wishClicked = false;
                        }
                    });
                });

                // ì¥ë°”êµ¬ë‹ˆ ë²„íŠ¼
                $('#btn-cart').click(function () {
                    const productId = $(this).data('product-id');
                    const cartColor = $('#colorSelect').val();
                    const cartSize = $('#sizeSelect').val();

                    if (!cartColor || !cartSize) {
                        alert('ì˜µì…˜ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.');
                        return;
                    }

                    $.ajax({
                        url: '/cart/add',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify({
                            productId: productId,
                            cartColor: cartColor,
                            cartSize: cartSize
                        }),
                        success: function () {
                            alert('ì¥ë°”êµ¬ë‹ˆì— ë‹´ê²¼ìŠµë‹ˆë‹¤!');
                        },
                        error: function () {
                            alert('ì¥ë°”êµ¬ë‹ˆ ë‹´ê¸° ì‹¤íŒ¨');
                        }
                    });
                });

                $('#buyNowBtn').on('click', function () {
                    const pid = $(this).data('product-id');
                    const co = $('#colorSelect').val();
                    const sz = $('#sizeSelect').val();

                    if (!co || !sz) {
                        alert('ì˜µì…˜ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                        return;
                    }

                    sessionStorage.setItem('orderColor', co);
                    sessionStorage.setItem('orderSize', sz);

                    // ì´ í•œ ì¤„ë§Œ ë‚¨ê¹ë‹ˆë‹¤.
                    window.location.href = `/order/submit/${pid}`;
                });

            });
        </script>
    </div>
</div>

<div th:replace="layout/footer :: footer"></div>

</body>

</html>